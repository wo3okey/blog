{"componentChunkName":"component---src-templates-post-jsx","path":"/jenkins-cicd/","result":{"data":{"site":{"siteMetadata":{"title":"wookey-devlog"}},"markdownRemark":{"id":"6e6ab2ab-8cc2-5179-b881-d2832b2738bd","excerpt":"AWS EC2에 Jenkins를 설치 및 어플리케이션 서버를 위한 추가적인 ec2 서버를 구성하면 좋지만, jenkins를 설치하기에는 프리티어 메모리 문제도 있으며, 추가적인 ec2 인스턴스를 기동시 비용 문제가 발생될 수 있다. 그래서 jenkins는 로컬에서 설치하며 어플리케이션 서버는 ec2로 구성하여 AWS 프리티어에서 가능한 수준의 간단한 CI…","html":"<p>AWS EC2에 Jenkins를 설치 및 어플리케이션 서버를 위한 추가적인 ec2 서버를 구성하면 좋지만, jenkins를 설치하기에는 프리티어 메모리 문제도 있으며, 추가적인 ec2 인스턴스를 기동시 비용 문제가 발생될 수 있다. 그래서 jenkins는 로컬에서 설치하며 어플리케이션 서버는 ec2로 구성하여 AWS 프리티어에서 가능한 수준의 간단한 CI/CD 구축을 해본다.</p>\n<h2>local docker 설치</h2>\n<p>도커 설치법은 생략한다. 도커 데스크탑까지 설치하면 좋다.</p>\n<h2>docker jenkins pull</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> pull jenkins/jenkins:lts</code></pre></div>\n<h2>docker jenkins run</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> volume create volume-jenkins</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> network create cicd-net</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-it</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> jenkins <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--net</span> cicd-net <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">50000</span>:50000 <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-v</span> volume-jenkins:/var/jenkins_home <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class=\"token punctuation\">\\</span>\njenkins/jenkins:lts</code></pre></div>\n<p>docker 컨테이너 종료 및 삭제 이후에도 설정을 유지하려면 volume 설정을 해주면 좋다. 그리고 docker 엔진은 host OS의 /var/run/docker.sock 아래에 마운트 된 unix 소켓을 사용한다.\ndocker.sock은 도커 컨테이너 내부에서 데몬과 상호 작용을 할 수 있게 해주는 unix 소캣이다.</p>\n<p>만약 권한 문제가 발생한다면 아래와 같이 권한을 주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> <span class=\"token number\">666</span> /var/run/docker.sock</code></pre></div>\n<h2>jenkins 접속 및 설치</h2>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/6c46ece2ee4f789c45993255b4cd9733/10796/jenkins-cicd-01.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 70.58823529411764%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWUlEQVR42p2TXVbDIBCFs/8V+Og+fHEHteqLrQvQpmkCJEDIz3VuWhLaejytnHPDQMjHnYFkVVWhKAporTEMw5XGcTzTb3Opsq7rQIUQsMTdHPd9P8dxfKl0k4wTzlqs12u8vKyw2Wyw3W7x/vaKlYzzPAcbF9/SMi4ktJTU8+KAoqxwUEriEgeJWYpGNqybBnVdw1oH5xZxTOczkA9adrJYqwZKW1TslUCMhdUGtdKSxRHAj8dTimmdz4DjMCKYBp2uJwUBUG2l4Us19X0bELMhhDVvxDV15ZATX9877KRe+/0eznt438K3iWSODtkToqQsqSJ0TrmdIB6tfDydWEwnKrk2XEOHFONjLe0CvKcRGl0SwoNiTPi/gHRICNMkiA5Z17Ma3trowhgzAaOjxbnoXiBrxV+VKf95sW8V02Xdprt48c64gNp39wHTCzyPTxs9PH3g8fkTP27cSmRrXU4gAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 01' title='' src='/blog/static/6c46ece2ee4f789c45993255b4cd9733/ca1dc/jenkins-cicd-01.png' srcset='/blog/static/6c46ece2ee4f789c45993255b4cd9733/e7570/jenkins-cicd-01.png 170w,\n/blog/static/6c46ece2ee4f789c45993255b4cd9733/f46e7/jenkins-cicd-01.png 340w,\n/blog/static/6c46ece2ee4f789c45993255b4cd9733/ca1dc/jenkins-cicd-01.png 680w,\n/blog/static/6c46ece2ee4f789c45993255b4cd9733/02d09/jenkins-cicd-01.png 1020w,\n/blog/static/6c46ece2ee4f789c45993255b4cd9733/10796/jenkins-cicd-01.png 1354w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">http://localhost:8080/</code>에 접속하면 설치를 위한 초기 패스워드를 입력이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-t</span> <span class=\"token parameter variable\">--user</span> root jenkins /bin/bash</code></pre></div>\n<p>docker 컨테이너에 root 권한으로 접속한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">cat</span> /var/jenkins_home/secrets/initialAdminPassword</code></pre></div>\n<p>초기 패스워드 정보는 위 경로에서 확인할 수 있으며, 해당 값을 입력 후 설치를 진행한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/4c152e6d487cf250b9416a31532d8544/f967b/jenkins-cicd-02.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 67.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB30lEQVR42p2TyXLbMAyG9f4P0kubc0/NtZcmmbRJVC+yTe2iSFGyLK+S/gJo3DqZdDJTez4LxPIDJGWvbVs458DPvu/fZBgGYRzHd/GOxyNOpxMGWvT9gH74jayfn0eKn575V8M/guw4HPZIYwWdp7BlAasLsZ0tYXT+dwL6vvfx+Odw6vHpyw1xiw+fv+Lq+k7WV8RHslO3o6wRA+1gHEaB7cspuaEINpsaddvgKbH4ERmixL0q8JhWeIgNbhcZgiRH263hWidU6wpN16Dbdui6DpvNBvv9nnZ6gHez+obv8T0C62PhJpjoR0z1E9JDhGU9pUZ38PMH+OSb2TlWlYJyCmmXQVcaoQqR5zl2ux222y08P/LBBDrAwiyxsgoroxA3CZZk+/FPLCg2L2bISaCp1zIVC1RVBaUUmqYBXy77vChOUBQFTGlgjUXtarE5yZE9nUwRzANEYQRrnYhoujTe5lnQGCNrmZAFtdbitNaioneyLLUEXV1jPp8hTVPylQLn8gCcyzVZlklznk4mTJJECjjAZ6FJjAs5OafCNEvFz/E4jl8QhqHADfgY+M8hgq8TmSiKEDMXPs69hBux/zyxCL4Wuix4q9ElPDXnnY+Mt+6x83+RM6eLYXg6vpRfgaHS/QeDGdsAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 02' title='' src='/blog/static/4c152e6d487cf250b9416a31532d8544/ca1dc/jenkins-cicd-02.png' srcset='/blog/static/4c152e6d487cf250b9416a31532d8544/e7570/jenkins-cicd-02.png 170w,\n/blog/static/4c152e6d487cf250b9416a31532d8544/f46e7/jenkins-cicd-02.png 340w,\n/blog/static/4c152e6d487cf250b9416a31532d8544/ca1dc/jenkins-cicd-02.png 680w,\n/blog/static/4c152e6d487cf250b9416a31532d8544/02d09/jenkins-cicd-02.png 1020w,\n/blog/static/4c152e6d487cf250b9416a31532d8544/9d567/jenkins-cicd-02.png 1360w,\n/blog/static/4c152e6d487cf250b9416a31532d8544/f967b/jenkins-cicd-02.png 1418w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>Install suggested plugins 를 클릭하여 기본 플러그인을 설치하면 위 처럼 설치가 진행된다.\n이후, 계정 및 간단한 이름을 등록하면 젠킨스를 시작할 수 있다.</p>\n<h2>jenkins 설정</h2>\n<h3>jenkins private key 등록</h3>\n<p>jenkins에 ssh 접속을 위한 과정이다. jenkins 내에서 자격 등록을 위해 private key를 등록하고, public key를 git에 등록할 예정이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-t</span> <span class=\"token parameter variable\">--user</span> root jenkins /bin/bash</code></pre></div>\n<p>이미 접속해있다면 상관없고, jenkins 컨테이너에 접속 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ssh-keygen</code></pre></div>\n<p>ssh key를 생성한다. 명령어 입력 후 엔터 계속 클릭하면 생성이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token builtin class-name\">cd</span> /root/.ssh/\n<span class=\"token function\">cat</span> id_rsa\n<span class=\"token function\">cat</span> id_rsa.pub</code></pre></div>\n<p>위 경로에 private key <code class=\"language-text\">id_rsa</code> 및 public key <code class=\"language-text\">id_rsa.pub</code> 가 각각 잘 생성되었는지 확인한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/46e4369cf4cdc1e64881c96005dedfc7/9c796/jenkins-cicd-06.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 110.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAABl0lEQVR42q2Uy1KEMBBF51v9KD/BtXuX7tzpzqVVzgMYHiGBJARy7Q5gSY06BE1VF03P1OH2I707nTIkyRlVJcF+XTfk18iyHFI2ISaEwvGY4nBIwjv7WVZAa3thO9Dx3vMDZVnRH89I0wz7/ZFANWLPApjnBcFSeuak4kRqNwLno1SDttFwrg9mrEXXOfTDsNoWQG0MCkqbUxe1pFoKGGPBCQyDD9b3w6+2APIXzpQ2A63tgkIGam3Qtjr40cBaqqCyJoUlKeTGCDGqlUrFAZ1zUE1DP/TwU8xPNjfvmi2BBOoIOteK39305dHvI1OmgKBR4Rpyg2K6+22XWQEXny2MyxU1qxS2Woeucj3CqKyo2481HFOWYcAZ1PsR6EIN19kFkIM8f82klBVzozbVkAOWaidJJc+hpJmUUoZx2nSXuSllKWiIK2w9FwoNXTneOkVRfG6hPwFHiP8fhZZWVkKbOKUlOxB83jAxtgB6gmCap/mqxVoADlOGT28dbh8Vnt+7aRlsTHkG3r9o3NxVeHg1+BqPAX4AWS/ENcl4o+8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 06' title='' src='/blog/static/46e4369cf4cdc1e64881c96005dedfc7/ca1dc/jenkins-cicd-06.png' srcset='/blog/static/46e4369cf4cdc1e64881c96005dedfc7/e7570/jenkins-cicd-06.png 170w,\n/blog/static/46e4369cf4cdc1e64881c96005dedfc7/f46e7/jenkins-cicd-06.png 340w,\n/blog/static/46e4369cf4cdc1e64881c96005dedfc7/ca1dc/jenkins-cicd-06.png 680w,\n/blog/static/46e4369cf4cdc1e64881c96005dedfc7/02d09/jenkins-cicd-06.png 1020w,\n/blog/static/46e4369cf4cdc1e64881c96005dedfc7/9d567/jenkins-cicd-06.png 1360w,\n/blog/static/46e4369cf4cdc1e64881c96005dedfc7/9c796/jenkins-cicd-06.png 1708w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Setting > Developer settings > Personal access tokens > tokens(classic) > Generate new token(classic)</code></pre></div>\n<p>위 경로에서 ssh private 자격을 등록한다. <code class=\"language-text\">SSH Username with private key</code> 타입으로 등록하며, ID는 아무거나 작성해도 좋다. 나는 ssh로 작성했다. 그리고 private key를 작성할때는 <code class=\"language-text\">id_rsa</code> 파일의 전체 정보를 넣으면 된다. 반드시 <code class=\"language-text\">-----BEGIN OPENSSH PRIVATE KEY-----</code> 문구 부터 <code class=\"language-text\">-----END OPENSSH PRIVATE KEY-----</code> 까지 끝까지 다 넣어주도록 한다.</p>\n<h4>github jenkins public key 등록</h4>\n<p>방금 등록한 private ssh와 대응되도록 git에는 public ssh를 등록한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">github > 등록할 레포지토리 > Settings > Deploy keys > Add deploy key</code></pre></div>\n<p>이름은 편하게 짓고, jenkins 컨테이너의 <code class=\"language-text\">id_rsa.pub</code> 파일 내용을 그대로 넣어주면 정상적으로 등록된다.</p>\n<h3>github developer token 발급</h3>\n<p>github에서 아래 경로로 이동 후 토큰을 발급한다. 이제는 jenkins에서 git에 연결하고 개발 관련 컨트롤을 하기 위함이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">전체 메뉴의 Setting > Developer settings > Personal access tokens > tokens(classic) > Generate new token(classic)</code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/d893e3fe595bbeb8e1e43951893323d3/b25d8/jenkins-cicd-03.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 108.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC20lEQVR42pVV13LbMBDUq6NCir2AYG8SKarEkjwp//9Xmzuo2JFFT/KwcwQILO/2CieWJ5EUKyztEN8WFua6C83wEdNeWnVIy7V6n9NzXq0R5y2mdG66MDFjq9mY6c7dTjyR4XD+jWq1hRummBkONMun9Q797oT18Ipue0SzOaHoz8i7I2S1Q0SQ9R4ibSHiEiKpEMgCEzcqMBzOqLu9IrTjBEtXICOPHFrznh/lsEUBU1SwwhJ2VMMMSoWlE0G3AhUh24luCxjOZaFeWCE001cfCOmrOh3UaF9T73y6SOcI8yWFqLFENj07d0w47kfMly7p1yOIa0x1D3MjwMIM6dnFy9zGy8LGN80he8P73oQvf4aDMk/Qr0pUZJsyU6jyGEUqCdHVyvu6zGIkMnxOuKBwNl2D42HAa5cQMnxfJzj2KU6bTNnb83koyOZ425bYNfIz4YzLhjQs2x5F08F2QziegONftNYsAdZddySd86AtLYJNTljQjdGQXay2Z1U6LpWVR1kOZImoHBCUewTFFl42QLPl9bx3x1PCKYkrs4bK6Q1R2tyLNqR6S4oWUVKSR5S8awI/4ikhX47SCtvXH4qECVkGQeQyX6ku4g6b/Q8hVz23nOlGWBieInTFpdBVA/jJexLp/Q0jIdvUwyscTr8QEjGv+bBIa+rllbLsbZjUfxGPesjgHi/bQQ0D9pg9dIKU9nNlVUvSx5wgudfuKCF7VNQ9dqShSVp91DDKKClZo8DectK4101XqjPjGtKhtj/AJg+4nzlkRZZeyOSVjEvKcITCqIZMKKg0NvuzGmv8ZT7MtchZ92lCsXa8/zgDvswy12HRbO4hB0QWUUJYx7nhfcrwl4RpPaCjAZuTlrzmC5yEMK6Uh0tqv2d3RwllVmF3/KlCfk9KTdq1ylMeqJd2+9dO4ZFOF1ls3ruVDXcIk92S8IhxD8kb/g0w0Y2QB4UbZmqyP+p3I/wDuDw4HkqCOB8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 03' title='' src='/blog/static/d893e3fe595bbeb8e1e43951893323d3/ca1dc/jenkins-cicd-03.png' srcset='/blog/static/d893e3fe595bbeb8e1e43951893323d3/e7570/jenkins-cicd-03.png 170w,\n/blog/static/d893e3fe595bbeb8e1e43951893323d3/f46e7/jenkins-cicd-03.png 340w,\n/blog/static/d893e3fe595bbeb8e1e43951893323d3/ca1dc/jenkins-cicd-03.png 680w,\n/blog/static/d893e3fe595bbeb8e1e43951893323d3/02d09/jenkins-cicd-03.png 1020w,\n/blog/static/d893e3fe595bbeb8e1e43951893323d3/b25d8/jenkins-cicd-03.png 1117w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>토큰의 권한은 레포를 관리할 수 있는 최소한만 줘도 된다. 토큰 이름은 jenkins로 지었으며, 토큰 만료기간은 따로 설정하지 않았다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/3991ce5db6e87ba8359a0841c3af73b8/6efed/jenkins-cicd-04.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+0lEQVR42k2QyW6EMBBEOSfA2JjFGzYYENuMRspyyCn//1WVtslhDk+22u2q6s7G5UTVWryVNQoukbMWxi+I9WE+EmF9QFMt9uSsQUHEPjuumPcn3HzC9QHOjsi+f36xPT6h3YxCdMh5C9XPcGGHJzE3Henuph12WCD9AW42lJUEqzV4Yy6EAiOy8/mF7f4BaQIaP4C1Co0OsH5C70c4qik7oFGeBBRu9KkUmqbpklCcjtEp1QCjKaGkmLV06VG0fXKWxmOaAkZiWpa0gsbMqP8R0kN0fTK5IEPSSAnfb9c+XuHkWnXxkwfXaxpRRGzkoCk8bmQc074SU/8BTBCC0Twelv4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 04' title='' src='/blog/static/3991ce5db6e87ba8359a0841c3af73b8/ca1dc/jenkins-cicd-04.png' srcset='/blog/static/3991ce5db6e87ba8359a0841c3af73b8/e7570/jenkins-cicd-04.png 170w,\n/blog/static/3991ce5db6e87ba8359a0841c3af73b8/f46e7/jenkins-cicd-04.png 340w,\n/blog/static/3991ce5db6e87ba8359a0841c3af73b8/ca1dc/jenkins-cicd-04.png 680w,\n/blog/static/3991ce5db6e87ba8359a0841c3af73b8/02d09/jenkins-cicd-04.png 1020w,\n/blog/static/3991ce5db6e87ba8359a0841c3af73b8/6efed/jenkins-cicd-04.png 1113w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>신규 발급된 토큰의 private key는 잘 저장해두고 복사한다.</p>\n<h4>jenkins git-hub credentials 등록</h4>\n<p>마찬가지로 jenkins에서도 해당 토큰을 연결해야한다. 서로 상호 연결한다고 생각하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Jenkins 대시보드 > Jenkins 관리 > Security > Credentials > global > Add Credentials</code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/f90cd8b54a01a0ede229fe21f5803832/d9c1b/jenkins-cicd-05.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVR42q2TyU7DMBCG8/4vwokX4MIdiSPiXk6lcYKXeLenM9OmggayCUu/7DjW538WN6dTB1Jq6DoJfa9AKcMyxoLWA7RtD3RmnK314H38Uw18G6UUOB4/WYfDB4IVbB1NrfX2kXMGITp0NyBMQwiB9+nMWv1wSBsSQRKdaW3AIzCXzBclUkqLau4tO+cZSIAYI7sMIeI6Ibwsagr0HlohGKq0Bm0Mz5QGckp5ntOvQCkVRLRfr4UqmAq6PY2hz2gCHH9Q/rwPHDI5Y+0JmZxRhallKExn3ba2ud+wzjGQKjb25s3hCk2AFGrA6q7N2WIOGUbVvBZiqybAAd+q6L642v8CrDVh3i7NvOZlzL6UXAAeXiw8vfkLfIcmwMdXC8/vHvaOM7TM7E5od7hDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 05' title='' src='/blog/static/f90cd8b54a01a0ede229fe21f5803832/ca1dc/jenkins-cicd-05.png' srcset='/blog/static/f90cd8b54a01a0ede229fe21f5803832/e7570/jenkins-cicd-05.png 170w,\n/blog/static/f90cd8b54a01a0ede229fe21f5803832/f46e7/jenkins-cicd-05.png 340w,\n/blog/static/f90cd8b54a01a0ede229fe21f5803832/ca1dc/jenkins-cicd-05.png 680w,\n/blog/static/f90cd8b54a01a0ede229fe21f5803832/02d09/jenkins-cicd-05.png 1020w,\n/blog/static/f90cd8b54a01a0ede229fe21f5803832/d9c1b/jenkins-cicd-05.png 1040w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Username with password</code>로 설정 후 본인의 git 아이디를 username에, 패스워드는 로그인할때 패스워드가 아닌, 방금 위에서 발급받은 token을 넣는다! git auth 정책이 바뀌어 일반 비밀번호를 넣으면 auth 에러가 발생하니, 반드시 유의할것!!!</p>\n<h3>jenkins docker-hub credentials 등록</h3>\n<p>도커 이미지를 push 하기 위해서는 jenkins에 도커 자격 증명이 필요하다. github 계정 등록과 같은 방법으로 docker hub 계정을 등록하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Jenkins 대시보드 > Jenkins 관리 > Security > Credentials > global > Add Credentials</code></pre></div>\n<p><code class=\"language-text\">Username with password</code>로 설정 후 본인의 docker 아이디를 username에, 패스워드를 입력 후 ID에는 아무값이나 구분자로 넣어준다.</p>\n<h4>ec2 jenkins public key 등록</h4>\n<p>application 서버로 사용할 ubuntu ec2에도 public key가 있다. 해당 부분은 아래 ec2 생성 후 다시 보는걸 추천한다. 이후 ec2에 접속 후 <code class=\"language-text\">authorized_keys</code> 를 ssh 경로에 만들어, jenkins의 public key를 등록한다. jenkins 컨테이너 내에서 만든 <code class=\"language-text\">id_rsa.pub</code> 파일을 그대로 넣으면 된다.</p>\n<p>jenkins 컨테이너의 public key 내용 복사</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">cat</span> /root/.ssh/id_rsa.pub</code></pre></div>\n<p>ec2 서버에 authorize_keys 파일에 내용 붙여넣기</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">vi</span> ~/.ssh/authorized_keys</code></pre></div>\n<h3>ssh agent 플러그인 설치</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/949ad36235600b2188d44586b5513ec4/89260/jenkins-cicd-07.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA5UlEQVR42q2RC2vDMAyE/f//4+ggtOTpxk/ZcZab5KRbKGMMOsHHCRufz7KyNiCEBOciEyohEHJekdLCWqr+FTWOEy6Xd2zbhueyNqLvNLwnRMqIcYdIWA7OPRsSJYyjRilrNRHjh7fn1NNkYI0/EpcK0bc+96rv72iaFtdrD60dp8kwhrCWD7zx+jR7NJ2DvjvMM6s2dSySWkZzRtIq7z3atsPt1vFzqCZc1z2t5oO5FBjr+flyWajqnGd2lTVB+pSqYYDMcRiGuvFqqWUpxw0OMs9zPT5qn+vvfBnin0v9lOgVw0/2ZsD6BsqKlgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 07' title='' src='/blog/static/949ad36235600b2188d44586b5513ec4/ca1dc/jenkins-cicd-07.png' srcset='/blog/static/949ad36235600b2188d44586b5513ec4/e7570/jenkins-cicd-07.png 170w,\n/blog/static/949ad36235600b2188d44586b5513ec4/f46e7/jenkins-cicd-07.png 340w,\n/blog/static/949ad36235600b2188d44586b5513ec4/ca1dc/jenkins-cicd-07.png 680w,\n/blog/static/949ad36235600b2188d44586b5513ec4/02d09/jenkins-cicd-07.png 1020w,\n/blog/static/949ad36235600b2188d44586b5513ec4/9d567/jenkins-cicd-07.png 1360w,\n/blog/static/949ad36235600b2188d44586b5513ec4/89260/jenkins-cicd-07.png 2072w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/da2abe98988c3e9ca2e446260b735e46/b5cb9/jenkins-cicd-09.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 55.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABTElEQVR42q2R2XKDMAxF/f/fl+lbZtKEfTEYvAAGbiW1SdOkeWo1c0ayMdeyrqrrDklSYBgciqJBmpYwxkruuhEhLPB+xjQtRBR47xXK+4C+H8A5xhXLErFtu2Rec805hBnOBVjrqZ4wz/FX1DCMOBzecD5f8Cr4YNv2yLIKl0uOpumla+emJ9S2bfQDP2nGvu8/hHjN31fCjg7LvGD9esXLDkPwqOuGbs/pVk/PizdBEVtZYEWat9B9wGgX6mQWLHX0Od94m7VyjgVbVBUbUpAho8xtXTeBa6YZJmTao+w8dWthekOmGTLTSiN8OYfSesDplAvHY0JOd2RSoMMeWjuM4yTCadkhIxIirQze8w4lzdIYQzPVMgYRZHfbVtNmK0/n+jFklgKE/S7fn2EUG6K1ps5KoSyrJ3Me5O/4FruGujp5hU34Syj8c3wAFhVaLZ9ktp0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 09' title='' src='/blog/static/da2abe98988c3e9ca2e446260b735e46/ca1dc/jenkins-cicd-09.png' srcset='/blog/static/da2abe98988c3e9ca2e446260b735e46/e7570/jenkins-cicd-09.png 170w,\n/blog/static/da2abe98988c3e9ca2e446260b735e46/f46e7/jenkins-cicd-09.png 340w,\n/blog/static/da2abe98988c3e9ca2e446260b735e46/ca1dc/jenkins-cicd-09.png 680w,\n/blog/static/da2abe98988c3e9ca2e446260b735e46/02d09/jenkins-cicd-09.png 1020w,\n/blog/static/da2abe98988c3e9ca2e446260b735e46/9d567/jenkins-cicd-09.png 1360w,\n/blog/static/da2abe98988c3e9ca2e446260b735e46/b5cb9/jenkins-cicd-09.png 1532w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>jenkins에서 직접 붙여쓰는 자격 증명과 별개로 ec2에 직접 ssh로 연결하기 위한 <code class=\"language-text\">SSH Agent</code> 플러그인, docker 파이프라인을 위한 <code class=\"language-text\">Docker Pipeline</code>을 available plugins에서 설치한다.\nDocker Pipeline은 미리 설치해놔서 검색 사진이 없다ㅎ</p>\n<h3>jenkins docker in docker 설치</h3>\n<p>jenkins 내에서 docker image build를 통해 docker hub에 push 하는 작업을 위해 docker 설치가 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-t</span> <span class=\"token parameter variable\">--user</span> root jenkins /bin/bash</code></pre></div>\n<p>터미널에서 jenkins 컨테이너 접속 후 아래 명렁어에 따라 docker를 설치를 한다. docker 컨테이너 내에서 docker를 설치해야하는 아이러니한 상황이긴하다. 이를 docker in docker라고 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">apt-get</span> update <span class=\"token parameter variable\">-y</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y<span class=\"token punctuation\">\\</span>\n    ca-certificates <span class=\"token punctuation\">\\</span>\n    <span class=\"token function\">curl</span> <span class=\"token punctuation\">\\</span>\n    gnupg <span class=\"token punctuation\">\\</span>\n    lsb-release</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/apt/keyrings</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://download.docker.com/linux/debian/gpg <span class=\"token operator\">|</span> gpg <span class=\"token parameter variable\">--dearmor</span> <span class=\"token parameter variable\">-o</span> /etc/apt/keyrings/docker.gpg</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"deb [arch=<span class=\"token variable\"><span class=\"token variable\">$(</span>dpkg --print-architecture<span class=\"token variable\">)</span></span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \\\n  <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release <span class=\"token parameter variable\">-cs</span><span class=\"token variable\">)</span></span> stable\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/docker.list <span class=\"token operator\">></span> /dev/null</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">apt-get</span> update <span class=\"token parameter variable\">-y</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin <span class=\"token parameter variable\">-y</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">docker</span> <span class=\"token parameter variable\">--version</span></code></pre></div>\n<p>docker 설치가 완료 되었으면 버전이 뜰 것이다. 확인해보면 된다. 여기까지 진행했으면, jenkins에서 설정해야하는 사항은 끝이다. </p>\n<h2>app server ec2</h2>\n<h3>ec2 생성</h3>\n<p>springboot application server를 띄울 ec2 하나를 띄운다. 나는 ubuntu os로 만들었으며, 어떠한 것으로 하든 상관 없다. 그 외 EC2 생성 방법은 생략하며, 키페어를 저장하고 위치만 잘 확인해두도록 한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/ffc38/jenkins-cicd-08.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAklEQVR42nVSi46DMAzj//9yu0kH7UQLDaU8c3EYDETPUjQRN46TrIh9z8ZaJup4HEdOKelvFyMHInbe8+P54hCC5odh4F5q8N22gZ8/L3bOM3UddxIFHkEwisCyLDzNM88SW/Gogr9lyUmEwIObpkmFYcIYq82Hz/uCBXXtVABY15XPIHEJR2fsb5DHRGd8BGu29p0tattW3ec4NPO+ueSKrahRl9gBbN8dpqwgGjnncg6dOqwqI8smJbAvAMuPsT+EEF+OuCyrI4/YBKWLMUYEq0NwdwHB/3YIzspBbw69XLJpGl0wLnjGJpgfef9rXQRBYmQiuoz1PUo4jnIf+c79Acv/wN9l12CEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 08' title='' src='/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/ca1dc/jenkins-cicd-08.png' srcset='/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/e7570/jenkins-cicd-08.png 170w,\n/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/f46e7/jenkins-cicd-08.png 340w,\n/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/ca1dc/jenkins-cicd-08.png 680w,\n/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/02d09/jenkins-cicd-08.png 1020w,\n/blog/static/8d30bbceddeb9f8bda0b7a9599445ccc/ffc38/jenkins-cicd-08.png 1110w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>다만 보안그룹 설정 시, 인바운드 설정이 필요하다. nginx를 통해 들어올 TCP 80포트 및 application server의 blue green 배포를 통해 들어올 8080, 8081 포트는 열어둬야 한다. 또한 ec2에 ssh 연결을 해야하므로 ssh 연결을 위한 22번 포트도 반드시 열어둬야한다. https 443 포트는 선택이다.</p>\n<h3>ec2 docker 설치</h3>\n<p>ec2에는 docker-compose 명령어를 통해 blue green 배포를 한다. 따라서 docker 및 docker-compose 설치가 필요하다. 설치 내용은 생략한다.</p>\n<h3>deploy.sh</h3>\n<p>jenkins에서 ssh 연결 후 실행시킬 deploy 쉘 스크립트가 필요하다. 이때 nginx가 설치(생략)되어 있어야하며 blue가 켜져있으면 green을, green이 켜져있으면 blue를 배포하는 간단한 스크립트이다. ec2의 root 경로에 작성했다.</p>\n<p>{컨테이너명} 부분은 필히 본인이 사용할 이름으로 변경해야한다! ex) {컨테이너명} -> test-container</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\">## 1</span>\n<span class=\"token assign-left variable\">EXIST_BLUE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker-compose</span> <span class=\"token parameter variable\">-p</span> <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-blue <span class=\"token parameter variable\">-f</span> docker-compose.blue.yaml <span class=\"token function\">ps</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Up<span class=\"token variable\">)</span></span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$EXIST_BLUE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token function\">docker-compose</span> <span class=\"token parameter variable\">-p</span> <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-blue <span class=\"token parameter variable\">-f</span> ~/docker-compose.blue.yaml up <span class=\"token parameter variable\">-d</span>\n    <span class=\"token assign-left variable\">BEFORE_COMPOSE_COLOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"green\"</span>\n    <span class=\"token assign-left variable\">AFTER_COMPOSE_COLOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"blue\"</span>\n    <span class=\"token assign-left variable\">BEFORE_PORT_NUMBER</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n    <span class=\"token assign-left variable\">AFTER_PORT_NUMBER</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token function\">docker-compose</span> <span class=\"token parameter variable\">-p</span> <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-green <span class=\"token parameter variable\">-f</span> ~/docker-compose.green.yaml up <span class=\"token parameter variable\">-d</span>\n    <span class=\"token assign-left variable\">BEFORE_COMPOSE_COLOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"blue\"</span>\n    <span class=\"token assign-left variable\">AFTER_COMPOSE_COLOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"green\"</span>\n    <span class=\"token assign-left variable\">BEFORE_PORT_NUMBER</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n    <span class=\"token assign-left variable\">AFTER_PORT_NUMBER</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${AFTER_COMPOSE_COLOR}</span> server up(port:<span class=\"token variable\">${AFTER_PORT_NUMBER}</span>)\"</span>\n\n<span class=\"token comment\">## 2</span>\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">cnt</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">do</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"서버 응답 확인중..(<span class=\"token variable\">${cnt}</span>/10)\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token assign-left variable\">UP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://localhost:$<span class=\"token punctuation\">{</span>AFTER_PORT_NUMBER<span class=\"token punctuation\">}</span>/actuator/health <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'UP'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">${UP}</span>\"</span> <span class=\"token punctuation\">]</span> \n        <span class=\"token keyword\">then</span>\n\t    <span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n\t    <span class=\"token builtin class-name\">continue</span>       \n        <span class=\"token keyword\">else</span>\n            <span class=\"token builtin class-name\">break</span>\n    <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$cnt</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"서버가 정상적으로 구동되지 않았습니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\">## 3</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s/<span class=\"token variable\">${BEFORE_PORT_NUMBER}</span>/<span class=\"token variable\">${AFTER_PORT_NUMBER}</span>/\"</span> /etc/nginx/conf.d/service-url.inc\n<span class=\"token function\">sudo</span> nginx <span class=\"token parameter variable\">-s</span> reload\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Deploy Completed!!\"</span>\n\n<span class=\"token comment\">## 4</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$BEFORE_COMPOSE_COLOR</span> server down(port:<span class=\"token variable\">${BEFORE_PORT_NUMBER}</span>)\"</span>\n<span class=\"token function\">docker-compose</span> <span class=\"token parameter variable\">-p</span> <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-<span class=\"token variable\">${BEFORE_COMPOSE_COLOR}</span> <span class=\"token parameter variable\">-f</span> docker-compose.<span class=\"token variable\">${BEFORE_COMPOSE_COLOR}</span>.yaml down</code></pre></div>\n<h4>docker-compose</h4>\n<p>위 쉴에서 구동할 blue, green docker-compose 파일이 필요하다. docker-compose.blue.yaml, docker-compose.green.yaml 각각의 compose 파일을 작성했다. deploy.sh 파일과 같은 ec2 root 경로에 작성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">version: <span class=\"token string\">'3.1'</span>\n \nservices: \n  api:\n    image: <span class=\"token punctuation\">{</span>dockerID<span class=\"token punctuation\">}</span>/<span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>\n    container_name: <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-blue\n    environment:\n      - <span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span>ko_KR.UTF-8\n      - <span class=\"token assign-left variable\">UWSGI_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n    ports:\n      - <span class=\"token string\">'8080:8080'</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">version: <span class=\"token string\">'3.1'</span>\n \nservices: \n  api:\n    image: <span class=\"token punctuation\">{</span>dockerID<span class=\"token punctuation\">}</span>/<span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>\n    container_name: <span class=\"token punctuation\">{</span>컨테이너명<span class=\"token punctuation\">}</span>-green\n    environment:\n      - <span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span>ko_KR.UTF-8\n      - <span class=\"token assign-left variable\">UWSGI_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n    ports:\n      - <span class=\"token string\">'8081:8080'</span></code></pre></div>\n<h2>jenkins pipeline</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">pipeline <span class=\"token punctuation\">{</span>\n    agent any\n\n    environment <span class=\"token punctuation\">{</span>\n        gitCredential <span class=\"token operator\">=</span> <span class=\"token string\">'git'</span>\n        dockerCredential <span class=\"token operator\">=</span> <span class=\"token string\">'docker-hub'</span>\n        sshCredential <span class=\"token operator\">=</span> <span class=\"token string\">'ssh'</span>\n    <span class=\"token punctuation\">}</span>\n\n    stages <span class=\"token punctuation\">{</span>\n        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'Prepare'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Clonning Repository'</span>\n                <span class=\"token function\">git</span> branch: <span class=\"token string\">'master'</span>, \n                url: <span class=\"token string\">'{연결할 git 레포지토리 http url}'</span>,\n                credentialsId: gitCredential\n            <span class=\"token punctuation\">}</span>\n            \n            post <span class=\"token punctuation\">{</span>\n                success <span class=\"token punctuation\">{</span> \n                    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Successfully Cloned Repository'</span>\n                <span class=\"token punctuation\">}</span>\n                failure <span class=\"token punctuation\">{</span>\n                    error <span class=\"token string\">'This pipeline stops here...'</span>\n                    \n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'Bulid Gradle'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          steps <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Bulid Gradle'</span>\n            dir<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token function\">sh</span> <span class=\"token string\">'./gradlew clean build'</span>           \n\t\t\t<span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          post <span class=\"token punctuation\">{</span>\n          \tsuccess <span class=\"token punctuation\">{</span> \n              <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Successfully Project Build'</span>\n            <span class=\"token punctuation\">}</span>\n            failure <span class=\"token punctuation\">{</span>\n              error <span class=\"token string\">'This pipeline stops here...'</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        \n        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'Bulid Docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          steps <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Bulid Docker'</span>\n            script <span class=\"token punctuation\">{</span>\n                dockerImage <span class=\"token operator\">=</span> docker.build<span class=\"token punctuation\">(</span><span class=\"token string\">\"{도커아이디}/{컨테이너명}\"</span>, <span class=\"token string\">\"--platform linux/x86_64 .\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          post <span class=\"token punctuation\">{</span>\n\t        success <span class=\"token punctuation\">{</span> \n              <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Successfully Docker Build'</span>\n            <span class=\"token punctuation\">}</span>\n            failure <span class=\"token punctuation\">{</span>\n              error <span class=\"token string\">'This pipeline stops here...'</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'Push Docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          steps <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Push Docker'</span>\n            script <span class=\"token punctuation\">{</span>\n                docker.withRegistry<span class=\"token punctuation\">(</span><span class=\"token string\">''</span>, dockerCredential<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    dockerImage.push<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          post <span class=\"token punctuation\">{</span>\n          \tsuccess <span class=\"token punctuation\">{</span> \n              <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Successfully Docker push'</span>\n            <span class=\"token punctuation\">}</span>\n            failure <span class=\"token punctuation\">{</span>\n              error <span class=\"token string\">'This pipeline stops here...'</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        \n\t\tstage<span class=\"token punctuation\">(</span><span class=\"token string\">'Docker Run'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Pull Docker Image &amp; Docker Image Run'</span>\n                sshagent <span class=\"token punctuation\">(</span>credentials: <span class=\"token punctuation\">[</span>sshCredential<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">sh</span> <span class=\"token string\">\"ssh -o StrictHostKeyChecking=no ubuntu@{ec2 IP주소} './deploy.sh'\"</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 스크립트에 <code class=\"language-text\">{XXX}</code> 해놓은 부분은 본인이 사용하고자 하는 명명에 맞게 변경해서 사용해야한다. 그대로 사용하면 절대안된다ㅎ\n참고로 jenkins 컨테이너 내에 pull 받은 git repo는 /var/jenkins_home/workspace 경로에 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/blog/static/09dc5c394b17c24cf995813f122c821a/04dd0/jenkins-cicd-10.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLUlEQVR42q2S627DIAyFef8nrKamTRsgBEiVK5BLe2qsTeqk7VdryUL6bB9jgzDOojxfcDh8wZgG75pIS8I8B4zjhGVZ3hd8PB74pIn/An81yuyHv4ZfuTgeCyil8ambipQStm371S3FSDsdse877zWEwDnzPKMfBqzr+s0j52Q+DCNzHjnDlBZKWhk66/jlp2lC61soqTBSgawUiuKEruuJ36BpskBikuLnU0miA0RjPUxteOwcsCSmjILUFZ0alXGw3sLfHDGFSksYWxOjprrhmKolLvKKmmqFrC0J1pioU7a4RVRTibIvUCdqsFHRZuDoVOEKOV9gmBvoKOH2hvPP/RE+Woj8B7uuQ95ltrRG6FCxm6hxuzt2vzYskD3zllh7t3CZU66KV/jk8ATppAfMhqxoaAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='jenkins cicd 10' title='' src='/blog/static/09dc5c394b17c24cf995813f122c821a/ca1dc/jenkins-cicd-10.png' srcset='/blog/static/09dc5c394b17c24cf995813f122c821a/e7570/jenkins-cicd-10.png 170w,\n/blog/static/09dc5c394b17c24cf995813f122c821a/f46e7/jenkins-cicd-10.png 340w,\n/blog/static/09dc5c394b17c24cf995813f122c821a/ca1dc/jenkins-cicd-10.png 680w,\n/blog/static/09dc5c394b17c24cf995813f122c821a/02d09/jenkins-cicd-10.png 1020w,\n/blog/static/09dc5c394b17c24cf995813f122c821a/9d567/jenkins-cicd-10.png 1360w,\n/blog/static/09dc5c394b17c24cf995813f122c821a/04dd0/jenkins-cicd-10.png 1826w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>중간중간 에러 있어서 9트에 완료..</p>","frontmatter":{"title":"간단한 jenkins docker CI/CD 구성","date":"March 24, 2024","update":"March 24, 2024","tags":["jenkins","cicd"],"series":"cs"},"fields":{"slug":"/jenkins-cicd/","readingTime":{"minutes":12.745}}},"seriesList":{"edges":[{"node":{"id":"fd12c43f-bc04-581f-8e37-6ae38bdf515b","fields":{"slug":"/http-protocol/"},"frontmatter":{"title":"HTTP 프로토콜 진화 과정"}}},{"node":{"id":"af219d10-dc7c-5b02-ad7d-f7f3318376b8","fields":{"slug":"/high-traffic/"},"frontmatter":{"title":"말도 많고 탈도 많은 대용량 트래픽는 대체 어떻게 처리할까?"}}},{"node":{"id":"cd427022-3331-5f4a-8322-79f6180f37c0","fields":{"slug":"/proxy/"},"frontmatter":{"title":"간단 nginx proxy 정리"}}},{"node":{"id":"6e6ab2ab-8cc2-5179-b881-d2832b2738bd","fields":{"slug":"/jenkins-cicd/"},"frontmatter":{"title":"간단한 jenkins docker CI/CD 구성"}}}]},"previous":{"fields":{"slug":"/spring-autowired/"},"frontmatter":{"title":"spring @Autowired 간단 정리"}},"next":{"fields":{"slug":"/aws-ecs/"},"frontmatter":{"title":"AWS ECS with git action 간단 체크포인트"}}},"pageContext":{"id":"6e6ab2ab-8cc2-5179-b881-d2832b2738bd","series":"cs","previousPostId":"35751dfa-4b11-56a0-872c-c532408db06e","nextPostId":"b9b2e471-f011-5f5c-a317-c5383a4220f1"}},"staticQueryHashes":[],"slicesMap":{}}